{% extends 'user_side/user_base.html' %}
{% load static %}
{% block content %}

<style>
    .wishlist-container {
        max-width: 1000px;
        margin: 50px auto;
        padding: 20px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .wishlist-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #ececec;
    }

    .wishlist-item:last-child {
        border-bottom: none;
    }

    .wishlist-item img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 20px;
    }

    .product-info h5 {
        margin: 0;
        font-size: 16px;
        color: #0066b2;
    }

    .product-info h4 {
        margin: 0;
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .product-info p {
        margin: 2px 0;
        color: #444;
    }

    .wishlist-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-left: auto;
    }

    .remove-btn {
        color: #d9534f;
        font-size: 14px;
        cursor: pointer;
    }

    .add-cart-btn,
    .go-cart-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
    }

    .add-cart-btn {
        background: #000;
        color: #fff;
    }

    .go-cart-btn {
        background: #007bff;
        color: #fff;
    }
</style>

<div class="wishlist-container">

    <h4 style="padding-bottom: 20px;">
        <span style="font-size: 24px;">♥️</span> My Wishlist
    </h4>

    {% if wishlists %}
        {% for wishlist in wishlists %}
        <div class="wishlist-item">

            <!-- IMAGE & PRODUCT LINK -->
            <a href="{% url 'product:product-detail-page' wishlist.variant.product.id %}">
                {% with wishlist.variant.product_variant_images_set.all.first as first_image %}
                    {% if first_image %}
                        <img src="{{ first_image.images.url }}" alt="">
                    {% else %}
                        <img src="{{ wishlist.variant.product.thumbnail.url }}" alt="">
                    {% endif %}
                {% endwith %}
            </a>

            <!-- PRODUCT INFO -->
            <div class="product-info">
                <h5>{{ wishlist.variant.product.product_brand }}</h5>
                <h4>{{ wishlist.variant.product.product_name }}</h4>

                <p>Size: {{ wishlist.variant.size }}</p>
                <p>Category: {{ wishlist.variant.product.product_category }}</p>
                <p><strong>₹ {{ wishlist.variant.product.offer_price }}</strong></p>
            </div>

            <!-- ACTION BUTTONS -->
            <div class="wishlist-actions">

                <!-- ADD / GO TO CART BUTTON (dynamic) -->
                <button class="add-cart-btn cart-action-btn"
                        data-variant-id="{{ wishlist.variant.id }}"
                        id="cart-btn-{{ wishlist.variant.id }}">
                    Loading...
                </button>

                <!-- REMOVE FROM WISHLIST -->
                <a href="#" class="remove-btn remove-item"
                   data-url="{% url 'userpanel:remove-wishlist' %}"
                   data-wishlist-id="{{ wishlist.id }}">
                    Remove
                </a>
            </div>

        </div>
        {% endfor %}
    {% else %}
        <h4>No items found in your wishlist</h4>
    {% endif %}

</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>
document.addEventListener("DOMContentLoaded", function () {


    $(".cart-action-btn").each(function () {
        let btn = $(this);
        let variantId = btn.data("variant-id");

        $.ajax({
            url: "{% url 'cart:button' %}",
            type: "GET",
            data: { variant_id: variantId },
            success: function (response) {
                if (response.is_in_cart) {
                    btn.text("Go to Cart");
                    btn.removeClass("add-cart-btn").addClass("go-cart-btn");
                } else {
                    btn.text("Add to Cart");
                }
            }
        });
    });


    $(".cart-action-btn").click(function () {
        let btn = $(this);
        let variantId = btn.data("variant-id");

        if (btn.hasClass("go-cart-btn")) {
            window.location.href = "{% url 'cart:cart-view' %}";
            return;
        }

        $.ajax({
            url: "{% url 'cart:add-to-cart' %}",
            type: "POST",
            data: {
                csrfmiddlewaretoken: "{{ csrf_token }}",
                variant_id: variantId,
                quantity: 1
            },
            success: function () {
                Swal.fire({
                    position: "top-end",
                    icon: "success",
                    title: "Added to cart",
                    toast: true,
                    showConfirmButton: false,
                    timer: 2000
                });

                btn.text("Go to Cart");
                btn.removeClass("add-cart-btn").addClass("go-cart-btn");
            }
        });
    });


    $('.remove-item').click(function(event) {
        event.preventDefault();
        var url = $(this).data('url');
        var wishlistId = $(this).data('wishlist-id');

        Swal.fire({
            title: 'Remove item?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes',
            cancelButtonText: 'No'
        }).then(result => {
            if (result.isConfirmed) {
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        wishlist_id: wishlistId
                    },
                    success: function () {
                        window.location.reload();
                    }
                });
            }
        });
    });

});
</script>

{% endblock %}
