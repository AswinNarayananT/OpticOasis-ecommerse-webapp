{% extends 'user_side/user_base.html' %}
{% load static %}

{% block content %}
<main class="container my-5">
    <h1 class="h2 mb-4">Checkout</h1>

    {% if messages %}
    <div class="alert alert-danger" role="alert">
        {% for message in messages %}
            {{ message }}
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" action="{% url 'orders:order-placed' %}" id="checkoutForm">
        {% csrf_token %}
        <input type="hidden" name="cart_item_ids" value="{{ cart_item_ids }}">
        <div class="row">
            <div class="col-lg-8">
                <!-- Shipping Address Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h3 class="card-title h5 mb-3">Select Shipping Address</h3>
                        <div class="row" id="addressList">
                            {% for address in user_addresses %}
                            <div class="col-md-6 mb-3 address-item">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="selected_address" id="address{{ address.id }}" value="{{ address.id }}" {% if forloop.first %}checked{% endif %}>
                                            <label class="form-check-label" for="address{{ address.id }}">
                                                <strong>{{ address.name }}</strong><br>
                                                {{ address.house_name }}, {{ address.street_name }}<br>
                                                {{ address.district }}, {{ address.state }}<br>
                                                {{ address.country }} - {{ address.pin_number }}<br>
                                                Phone: {{ address.phone_number }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newAddressModal">
                                            <i class="bi bi-plus-lg"></i> Add New Address
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Order Summary Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h3 class="card-title h5 mb-3">Order Summary</h3>
                        {% for item in cart_items %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                {% if item.variant_image %}
                                    <img src="{{ item.variant_image.images.url }}" alt="{{ item.product.product_name }}" class="img-fluid rounded me-3" style="width: 50px; height: 50px;">
                                {% else %}
                                    <img src="{{ item.product.thumbnail.url }}" alt="{{ item.product.product_name }}" class="img-fluid rounded me-3" style="width: 50px; height: 50px;">
                                {% endif %}
                                <div>
                                    <h6 class="my-0">{{ item.product.product_name }}</h6>
                                    <small class="text-muted">Quantity: {{ item.quantity }}</small>
                                </div>
                            </div>
                            <span class="text-muted">₹{{ item.sub_total }}</span>
                        </div>
                        {% endfor %}
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <span>₹{{ cart_total }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping</span>
                            <span class="text-success">Free</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-4">
                            <span class="h5">Total</span>
                            <span class="h5" id="cartTotal">₹{{ cart_total }}</span>
                        </div>
                    </div>
                </div>

                <!-- Payment Method Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h3 class="card-title h5 mb-3">Payment Method</h3>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="payment_method" id="wallet" value="credit_card" checked>
                            <label class="form-check-label" for="wallet">
                                wallet
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="payment_method" id="razorpay" value="razorpay">
                            <label class="form-check-label" for="razorpay">
                                razorpay
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="cashOnDelivery" value="cash_on_delivery">
                            <label class="form-check-label" for="cashOnDelivery">
                                Cash on Delivery
                            </label>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100">Place Order</button>
            </div>
        </div>
    </form>
</main>

<!-- New Address Modal -->
<div class="modal fade" id="newAddressModal" tabindex="-1" aria-labelledby="newAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newAddressModalLabel">Add New Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newAddressForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <input type="text" class="form-control" name="name" placeholder="Name" required>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control" name="house_name" placeholder="House Name" required>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control" name="street_name" placeholder="Street Name" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <input type="text" class="form-control" name="pin_number" placeholder="PIN Code" required>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" name="district" placeholder="District" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <input type="text" class="form-control" name="state" placeholder="State" required>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" name="country" placeholder="Country">
                        </div>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control" name="phone_number" placeholder="Phone Number" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Address</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('saveNewAddress').addEventListener('click', function(event) {
        event.preventDefault();
        var form = document.getElementById('newAddressForm');
        var formData = new FormData(form);
    
        fetch('{% url "orders:add-address" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        }).then(data => {
            console.log(data); // Log the response data for debugging
            if (data.success) {
                var newAddress = `
                    <div class="col-md-6 mb-3 address-item">
                        <div class="card">
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="selected_address" id="address${data.address_id}" value="${data.address_id}" checked>
                                    <label class="form-check-label" for="address${data.address_id}">
                                        <strong>${data.name}</strong><br>
                                        ${data.house_name}, ${data.street_name}<br>
                                        ${data.district}, ${data.state}<br>
                                        ${data.country} - ${data.pin_number}<br>
                                        Phone: ${data.phone_number}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('addressList').insertAdjacentHTML('afterbegin', newAddress);
                document.getElementById('newAddressForm').reset();
                var newAddressModal = new bootstrap.Modal(document.getElementById('newAddressModal'));
                newAddressModal.hide();
            } else {
                alert('Failed to add address: ' + data.error);
            }
        }).catch(error => {
            console.error('Error:', error); // Log any errors
            alert('An error occurred: ' + error.message);
        });
    });
    </script>
    
    
{% endblock %}
